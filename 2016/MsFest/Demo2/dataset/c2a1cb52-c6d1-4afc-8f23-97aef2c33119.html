 <html lang="cs-CZ"> <head> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta charset="utf-8" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /> <meta name="author" content="Petr Soukup" /> <title>Škálovatelné nasazení Let&apos;s Encrypt | Souki.cz</title> <link rel="alternate" type="application/rss+xml" title="Souki.cz » RSS zdroj" href="https://www.souki.cz/feed" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@PetrSoukup" /> <meta name="twitter:creator" content="@PetrSoukup" /> <meta property="og:title" content="Škálovatelné nasazení Let's Encrypt | Souki.cz" /> <meta property="og:type" content="article" /> <meta property="og:url" content="https://www.souki.cz/skalovatelne-nasazeni-letsencrypt" /> <meta property="og:description" content="Let's Encrypt je nová certifikační autorita nabízející HTTPS zdarma a s jednoduchým nasazením - dokud máte jednoduchý web." /> <meta name="description" content="Let's Encrypt je nová certifikační autorita nabízející HTTPS zdarma a s jednoduchým nasazením - dokud máte jednoduchý web." /> <meta property="og:image" content="https://www.souki.cz/uploads/2015-12-14-letsencrypt.png" />   <style id="criticalcss">.heading,.logo{font-weight:700}.sideleft,.sideright{z-index:99999;width:230px;min-height:100%;position:absolute}ul{list-style:none}a{text-decoration:none;color:#7cc576}a,body,div,form,h2,html,i,iframe,img,li,p,span,strong,table,tbody,td,tr,ul{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:0 0}.logo,td{vertical-align:middle}.sideleft,.sideright{background-color:#363f48;color:#646f7b}.clearfix:after{content:&quot;&quot;;display:block;height:0;clear:both;visibility:hidden}.clearfix{display:block}img{max-width:100%;height:auto}table{border-collapse:collapse;border-spacing:0;border:1px solid #ccc;line-height:18px;margin:0 0 22px;padding:0 5px}.logo,td{text-align:center}tr{border-bottom:1px solid #ccc}td{padding:5px}body,html{font-family:&quot;Segoe UI&quot;,Frutiger,&quot;Frutiger Linotype&quot;,&quot;dejavu sans&quot;,&quot;helvetica neue&quot;,arial,sans-serif;margin:0;padding:0;font-size:14px;line-height:24px;word-wrap:break-word}.sideleft{left:0;padding:0 30px 20px}.content{float:left;padding-left:300px;padding-right:290px;padding-bottom:20px;position:absolute;left:0;right:0;top:0}.sideright{padding:0 30px 20px;right:0}.ck,.px1{background:#363f48;position:fixed;display:none;cursor:pointer}.px1{width:100%;height:100%;opacity:.4;z-index:9999999}.ck{width:30px;height:30px;z-index:99999999;right:0;top:30px}.ck i,.logo{display:block}.ck i{width:16px;height:16px;margin-left:7px;margin-top:7px}.logo{margin:30px auto 0;font-size:38px;font-family:Verdana;width:230px;height:64px;line-height:64px}.heading{text-transform:uppercase;font-size:14px}.widget_recent_entries ul{margin-top:5px}.widget_recent_entries ul li a{color:#a0aab5}.widget{margin-top:30px}.widget_text .textwidget{padding-top:5px;color:#a0aab5}.post{margin-top:50px}.leftbar-post{width:50px;padding-left:10px;padding-right:10px;float:left}.leftbar-post .p-info{line-height:14px;margin-top:10px;font-size:13px;color:#b8b8b8;text-align:center}.leftbar-post .i-comment{display:inline-block;height:12px;width:12px;padding-right:3px}.leftbar-post .p-spacer{border-left:1px solid #dcdbdb;width:1px;height:40px;margin:10px auto 5px}.leftbar-post .p-fb,.leftbar-post .p-gg,.leftbar-post .p-tw{height:25px;width:25px;margin-left:12px;margin-top:5px;display:inline-block}.rightbar-post{padding:0 15px;margin-left:70px}.rightbar-post .p-head{margin-top:10px;font-size:14px;color:#c7c7c7;font-weight:400}.rightbar-post .p-head a{color:#c7c7c7}.rightbar-post .p-desc,.rightbar-post .p-desc p{color:#000;font-size:16px;line-height:30px;margin-bottom:15px}.p-desc h2{font-size:30px;color:#000;font-weight:400;line-height:38px;margin-top:15px;text-transform:none}.rightbar-post .p-title{font-size:30px;line-height:36px;font-weight:700;color:#141414;display:block;margin-top:20px}.rightbar-post .more-link{-webkit-border-radius:3px;-moz-border-radius:3px;font-size:18px;font-weight:700;text-transform:uppercase;background:#7cc576;border-radius:3px;color:#fff;padding:11px 16px;display:block;margin-top:20px;border:3px solid #7cc576;clear:both;width:110px;text-align:center}.p-head{font-size:18px;font-weight:700;margin-bottom:20px}.airtheme a{color:#006BB2}.airtheme .rightbar-post .more-link{background:#006BB2;border:3px solid #006BB2}.airtheme ::-moz-selection{background:#006BB2}.logo,.textwidget a{color:#fff!important}@media (max-width:1026px){.logo{margin-top:15px!important}}@media (max-width:800px){.rightbar-post .p-desc,.rightbar-post .p-desc p{font-size:16px}.rightbar-post .p-title{font-size:24px}}.gsc-control-cse{background-color:#4d5864!important;border-color:#4d5864!important;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;padding:5px 0!important}.gsc-control-cse tr{border:none}@media (min-width:1024px) and (max-width:1200px){.content,body{background:0 0}.sideright{display:none;z-index:999999999;position:fixed;overflow:scroll;height:100%}.content{padding-right:0}.ck{display:block}}@media (max-width:1023px){.content-sideleft,.leftbar-post{display:none}.sideleft,.sideright{position:static;width:auto;color:#646f7b;min-height:inherit}body,html{background:0 0}.sideleft{padding:10px 45px 20px;background-color:#363f48}.content{width:auto;float:none;padding-left:0;padding-right:0;z-index:999;padding-bottom:20px;background:0 0;position:static}.sideright{background-color:#363f48;z-index:99999;padding:1px 45px 20px}.rightbar-post{margin:0;padding:0 45px}}@media (max-width:460px){.sideleft,.sideright{background-color:#363f48;position:static;width:auto;padding:10px 20px 20px;color:#646f7b;min-height:inherit}.sideright{z-index:99999}.rightbar-post{margin:0;padding:0 20px}}#overlay-fade,#overlay-img{display:none;position:absolute}</style> <link rel="prefetch" href="/css/cpn4eynl.css" />  <link rel="shortcut icon" href="/favicon.ico" />  <link rel="apple-touch-icon" sizes="57x57" href="/images/ico/apple-icon-57x57.png" /> <link rel="apple-touch-icon" sizes="60x60" href="/images/ico/apple-icon-60x60.png" /> <link rel="apple-touch-icon" sizes="72x72" href="/images/ico/apple-icon-72x72.png" /> <link rel="apple-touch-icon" sizes="76x76" href="/images/ico/apple-icon-76x76.png" /> <link rel="apple-touch-icon" sizes="114x114" href="/images/ico/apple-icon-114x114.png" /> <link rel="apple-touch-icon" sizes="120x120" href="/images/ico/apple-icon-120x120.png" /> <link rel="apple-touch-icon" sizes="144x144" href="/images/ico/apple-icon-144x144.png" /> <link rel="apple-touch-icon" sizes="152x152" href="/images/ico/apple-icon-152x152.png" /> <link rel="apple-touch-icon" sizes="180x180" href="/images/ico/apple-icon-180x180.png" /> <link rel="icon" type="image/png" sizes="192x192" href="/images/ico/android-icon-192x192.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/images/ico/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="96x96" href="/images/ico/favicon-96x96.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/images/ico/favicon-16x16.png" /> <link rel="icon" href="/images/minilogo.png" sizes="any" type="image/svg+xml" /> <link rel="manifest" href="/manifest.json" /> <meta name="msapplication-TileColor" content="#363f48" /> <meta name="msapplication-TileImage" content="/images/ico/ms-icon-144x144.png" /> <meta name="theme-color" content="#363f48" /> </head> <body class="blog airtheme"> <div class="px1" /> <div class="container"> <div class="sideleft"> <a href="#" class="show-menu" /> <a href="/" class="logo">Souki.cz</a> <div class="nav"> </div> <div class="content-sideleft"> <div id="recent-posts-6" class="widget widget_recent_entries"> <div class="heading">Nejnovější příspěvky</div> <ul> <li> <a href="/jak-si-zabit-eshop-mericim-kodem">Jak si (ne)zabít eshop měřícím kódem</a> </li> <li> <a href="/kouzelne-grafy">Jak se kouzlí s grafy v politice</a> </li> <li> <a href="/jak-vypada-pridani-nove-funkce">Jak vypadá přidání nové funkce aneb &quot;když už to dělám&quot;</a> </li> <li> <a href="/jak-eet-skutecne-dopadne-na-eshopy">Jak EET skutečně dopadne na eshopy</a> </li> <li> <a href="/eet-pro-eshopy-je-postavene-na-hlavu">EET pro eshopy je postavené na hlavu</a> </li> <li> <a href="/hejt-na-produktova-data-dodavatelu">Hejt na produktová data dodavatelů</a> </li> <li> <a href="/co-noveho-v-shopapi">Co nového v ShopAPI</a> </li> <li> <a href="/jak-vam-heureka-krade-data">Jak vám Heuréka krade data</a> </li> <li> <a href="/velky-bratr-heureka">Velký bratr Heuréka</a> </li> <li> <a href="/loadbalancing-v-aws-cloudu">Loadbalancing v AWS cloudu</a> </li> </ul> </div> <div id="followusbox-2" class="widget FollowUsBox"> <div id="followusbox"> <div class="twitter-box" style="margin-bottom:15px"><a href="https://twitter.com/petrsoukup" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @petrsoukup</a> </div> <div class="fb-like" data-href="https://www.facebook.com/Soukicz/" data-width="200" data-layout="standard" data-action="like" data-show-faces="false" data-share="false" /> </div> </div> <div class="hidden-lg"> <div id="search-4" class="widget widget_search"> <gcse:search /> </div> <div id="text-4" class="widget widget_text"> <div class="heading">O blogu</div> <div class="textwidget">Blog o <a href="https://www.simplia.cz">provozování</a> eshopů a technologickém zázemí. <br /> Aktuálně řeším hlavně cloud, bezpečnost a optimalizaci rychlosti. <br /><br /> Rozjíždím <a href="https://shopapi.cz">službu</a> pro propojení eshopů s dodavateli. </div> </div> </div> </div> </div> <div class="content"> <div class="post type-post status-publish format-standard has-post-thumbnail hentry"> <div class="post"> <div class="leftbar-post"> <div class="p-info"><i class="i-comment" /> <span class="dsq-postid disqus-comment-count" data-disqus-url="https://www.souki.cz/skalovatelne-nasazeni-letsencrypt" /></div> <div class="p-spacer" /> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.souki.cz%2Fskalovatelne-nasazeni-letsencrypt" target="_blank" class="p-fb" /> <a href="https://twitter.com/intent/tweet?=More%20filters!&tw_p=tweetbutton&url=https%3A%2F%2Fwww.souki.cz%2Fskalovatelne-nasazeni-letsencrypt" target="_blank" class="p-tw" /> <a href="https://www.google.com/bookmarks/mark?op=add&bkmk=https%3A%2F%2Fwww.souki.cz%2Fskalovatelne-nasazeni-letsencrypt&title=undefined" target="_blank" class="p-gg" /> </div> <div class="rightbar-post"> <h1 class="p-title">Škálovatelné nasazení Let&apos;s Encrypt</h1> <div class="p-head"> Posted 22. 11. 2015 / By Petr Soukup / <a href="/category/bezpecnost/" rel="category tag">Bezpečnost</a> </div> <div class="p-desc"> <p>Let&apos;s Encrypt je nová certifikační autorita nabízející HTTPS zdarma a s jednoduchým nasazením. Jednoduché ale jen pokud máte jednoduchý web - například při škálovaném webu je paradoxně nasazení mnohem komplikovanější než už klasických autorit. Pokud ovšem nepoužijete trik!</p> <p><img class="full aligncenter size-full" src="/uploads/2015-12-14-letsencrypt.png" /></p> <a id="more" name="more" /> <h2 id="jednoduch-varianta">Jednoduchá varianta</h2> <p>Cílem Let&apos;s Encrypt je maximálně automatizovat nasazení. Pokud máte jednoduchý web na VPS, tak můžete mít v provozu HTTPS zavoláním jednoho příkazu - ověření domény i nasazení certifikátu. Jak to funguje?</p> <ul> <li>aplikace Let&apos;s Encrypt spustí malý web server, který poslouchá na portu 80 a servíruje odpovědi</li> <li>vygeneruje privátní klíč a pošle žádost na <a href="https://letsencrypt.org/">https://letsencrypt.org/</a></li> <li>server Let&apos;s Encrypt pak zavolá URL například <a href="http://example.org/.well-known/acme-challenge/4e29342d9904d64e9e25fd3b92558e2f">http://example.org/.well-known/acme-challenge/4e29342d9904d64e9e25fd3b92558e2f</a></li> <li>aplikace Let&apos;s Encrypt na tento požadavek odpoví hashem</li> <li>tím proběhlo ověření a je vystaven certifikát</li> <li>aplikace certifikát rovnou nainstaluje</li> </ul> <p>Zní to složitě, ale z vašeho pohledu je to jeden příkaz a celé to proběhne asi za 5 sekund. Certifikát pak má platnost jen 3 měsíce, ale díky automatizaci není problém vystavovat nový třeba každý měsíc.</p> <h2 id="-k-lovateln-web">Škálovatelný web</h2> <p>Problém nastavá, pokud nemáte jednoduchý web. Například my jsme v cloudu a jedna doména tak běží paralelně třeba z 10ti serverů. Ty se navíc různě vypínají a zapínají, domény ještě různě sdílí certifikáty atd.</p> <p>Při klasickém postupu by to znamenalo přepnout se do manuálního režimu, nechat si vygenerovat ověřovací klíče, ty rozkopírovat na servery a rychle spustit ověření, než se zapne nová instance. To nezní moc automaticky.</p> <p>Naštěstí ale lze udělat trik. V konfiguraci všech domén (nginx) přidám tyto řádky:</p> <pre><code class="lang-nginx"> location ~ /\.well-known/acme-challenge/ { proxy_pass http://letsencrypt.simplia.cz:8081; } </code></pre> <p>Díky tomuto jednoduchému pravidlu je každý požadavek na ověření přeposlán na jeden server, kde běží Let&apos;s Encrypt aplikace. Ta navíc ani nemusí běžet pořád. Stačí třeba jednou denně spustit a vygenerovat potřebné certifikáty.</p> <p>Pro spouštění mimochodem doporučuji použít Docker - ušetříte si spoustu starostí s řešením Python závislostí. Aplikace navíc nekoliduje s vaším normálním webserverem.</p> <pre><code class="lang-bash">docker run -it --rm -p 8081:80 --name letsencrypt \ -v &quot;/etc/letsencrypt:/etc/letsencrypt&quot; \ -v &quot;/var/lib/letsencrypt:/var/lib/letsencrypt&quot; \ quay.io/letsencrypt/letsencrypt:latest --agree-dev-preview \ --standalone-supported-challenges http-01 \ --server https://acme-v01.api.letsencrypt.org/directory \ -a standalone certonly \ -d www.souki.cz -d souki.cz </code></pre> <p>Certifikát bude následně uložen do složky <em>/var/lib/letsencrypt</em> a už je potřeba jen vyřešit jeho deploy na jednotlivé servery. My to třeba řešíme přes Puppet (viz <a href="/snadna-sprava-vice-serveru">dřívější článek</a>). </p> <h2 id="pozor-na-kompatibilitu">Pozor na kompatibilitu</h2> <p>V teorii to funguje hezky, ale v praxi to bohužel zatím použít nejde. Let&apos;s Encrypt totiž aktuálně nefunguje na Windows XP v IE ani ve Chrome a u nás má bohužel XP ještě znatelný podíl. Také se mi ho nepodařilo zprovoznit na Android 2.3, ale to jsem prý jediný :)</p> <p>Zatím je ale Let&apos;s Encrypt pořád ještě v betě, tak to třeba vyřeší. Zatím to ale pro seriózní produkci bohužel není. </p> <p><img class="full aligncenter size-full" src="/uploads/2015-12-14-letsencrypt-error.png" /></p> <div class="tags"> Tags: <a href="/tag/https/">https</a>, <a href="/tag/bezpecnost/"> bezpečnost</a>, <a href="/tag/cloud/"> cloud</a> <br /> </div> <div class="social-buttons"> <div class="fb-like" data-href="https://www.souki.cz/skalovatelne-nasazeni-letsencrypt" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" /> <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://www.souki.cz/skalovatelne-nasazeni-letsencrypt" data-via="petrsoukup" data-size="large">Tweet</a> <a href="https://twitter.com/petrsoukup" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @petrsoukup</a> <div class="g-plusone" data-annotation="inline" data-width="300" /> </div> <br /> <div> <div style="float:left;width:49%"> « <a href="/o-pytlickovani-objednavek" rel="prev">O pytlíčkování objednávek</a> </div> <div style="float:left;width:49%;text-align:right"> <a href="/vyvojarske-ohlednuti" rel="prev">Vývojářské ohlednutí</a> » </div> </div> <br clear="all" /> </div> <div class="clearfix" /> </div> </div>  </div> <div id="disqus_thread"> <div id="dsq-content"> <div id="disqus_thread" /> <script> var disqus_config = function () { this.page.url = &apos;https://www.souki.cz/skalovatelne-nasazeni-letsencrypt&apos;; }; </script> <script src="https://soukicz.disqus.com/embed.js" async defer /> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> <div class="sideright"> <div class="reserve-content-sideleft" /> <div id="search-4" class="widget widget_search"> <gcse:search /> </div> <div id="text-4" class="widget widget_text"> <div class="heading">O blogu</div> <div class="textwidget">Blog o <a href="https://www.simplia.cz">provozování</a> eshopů a technologickém zázemí. <br /> Aktuálně řeším hlavně cloud, bezpečnost a optimalizaci rychlosti. <br /><br /> Rozjíždím <a href="https://shopapi.cz">službu</a> pro propojení eshopů s dodavateli. </div> </div> </div> </div> <div class="clearfix" /> <script type="text/javascript">var countVars = {&quot;disqusShortname&quot;: &quot;soukicz&quot;};</script> <script>ga=function(){ga.q.push(arguments)},ga.q=[],ga.l=+new Date,ga(&quot;create&quot;,&quot;UA-1749596-34&quot;,&quot;auto&quot;),ga(&quot;send&quot;,&quot;pageview&quot;);</script> <script src="//www.google-analytics.com/analytics.js" async defer /> <script src="/js/highlight-8qodos72.js" async defer /> <script src="/js/app-bckqz6av.js" async defer /> <script id="dsq-count-scr" src="https://soukicz.disqus.com/count.js" async defer /> <script src="https://platform.twitter.com/widgets.js" async defer id="twitter-wjs" /> <script src="https://connect.facebook.net/cs_CZ/sdk.js#xfbml=1&version=v2.5&appId=1520219004894586" async defer id="facebook-jssdk" /> <script src="https://apis.google.com/js/platform.js" async defer>{lang: &apos;cs&apos;}</script> <script src="https://cse.google.com/cse.js?cx=000553325203901952068:mkk8sshmuva" async defer /> <div id="fb-root" />  <script> var cb = function () { var l = document.createElement(&apos;link&apos;); l.rel = &apos;stylesheet&apos;; l.href = &apos;/css/cpn4eynl.css&apos;; l.onload = function () { document.head.removeChild(document.getElementById(&apos;criticalcss&apos;)); }; var h = document.getElementsByTagName(&apos;head&apos;)[0]; h.parentNode.insertBefore(l, h); }; var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame; if (raf) raf(cb); else window.addEventListener(&apos;load&apos;, cb); </script> <noscript><link href="/css/cpn4eynl.css" rel="stylesheet" /></noscript>  </body> </html> 